## Orthology search and paralogy pruning
[OrthoFinder](https://github.com/davidemms/OrthoFinder) was used to group the extracted coding regions into orthogroups. We used [DIAMOND](https://github.com/bbuchfink/diamond) to BLAST the proteins, [MAFFT](https://github.com/GSLBiotech/mafft) to align the orthogroups and [RAxML](https://github.com/stamatak/standard-RAxML) to infer the gene trees.

    python3 /home/saabalde/bin/OrthoFinder_source/orthofinder.py -f PROTEINS_directory -S diamond -M msa -A mafft -T raxml -t 4 -a 4

OrthoFinder assigned 229,299 genes (92.5% of the total) to 15758 orthogroups. Fifty percent of all genes were in orthogroups with 27 or more genes (G50 was 27) and were contained in the largest 1834 orthogroups (O50 was 1834). There were 2 orthogroups with all species present and 0 of these consisted entirely of single-copy genes.

Since all orthogroups are multicopy, we pruned the paralogs (homolog genes originated from duplication events) using [PhyloPyPruner](https://pypi.org/project/phylopypruner/). But first, we need to prepare the data. Instead of working with all orthogroups, we first filtered out all with fewer than four species: 7,824 orthogroups. We created a list of genes, called "00-Orthogroups.Atleastfour.txt", from the "Orthogroups.GeneCount.tsv" files generated by OrthoFinder. Using that list, we fetched the corresponding alignments and gene trees.

    mkdir -p 01-OrthoFinder_Alignments 02-Orthofinder_Genetrees
    
    while IFS='' read -r LINE || [ -n "${LINE}" ]
        do
        cp 00-OrthoFinder_300aa_final/OrthoFinder/Results_Mar13/MultipleSequenceAlignments/${LINE}.fa ./01-OrthoFinder_Alignments/
    done < 00-Orthogroups.Atleastfour.txt 
    while IFS='' read -r LINE || [ -n "${LINE}" ]
        do
        cp 00-OrthoFinder_300aa_final/OrthoFinder/Results_Mar13/Gene_Trees/${LINE}_tree.txt ./02-Orthofinder_Genetrees
    done < 00-Orthogroups.Atleastfour.txt 

Now, we format the files for PhyloPyPruner.

    # Alignments 
    orthofinder2phylopypruner Species.list 01-OrthoFinder_Alignments

    # Gene trees
    for i in 02-Orthofinder_Genetrees/*tree.txt
        do
        sed -i 's/19_228\_/19_228\./g' $i
        sed -i 's/19_375\_/19_375\./g' $i
        sed -i 's/19_380\_/19_380\./g' $i
        sed -i 's/20_005\_/20_005\./g' $i
        sed -i 's/20_022\_/20_022\./g' $i
        sed -i 's/20_023\_/20_023\./g' $i
        sed -i 's/20_026\_/20_026\./g' $i
        sed -i 's/20_038\_/20_038\./g' $i
        sed -i 's/20_053\_/20_053\./g' $i
        sed -i 's/20_063\_/20_063\./g' $i
        sed -i 's/20_073\_/20_073\./g' $i
        sed -i 's/20_078\_/20_078\./g' $i
        sed -i 's/20_082\_/20_082\./g' $i
        sed -i 's/20_093\_/20_093\./g' $i
        sed -i 's/20_115\_/20_115\./g' $i
        sed -i 's/20_132\_/20_132\./g' $i
        sed -i 's/DRR151142\_/DRR151142\./g' $i
        sed -i 's/P15761_101\_/P15761_101\./g' $i
        sed -i 's/P15761_102\_/P15761_102\./g' $i
        sed -i 's/P15761_110\_/P15761_110\./g' $i
        sed -i 's/P15761_117\_/P15761_117\./g' $i
        sed -i 's/P15761_125\_/P15761_125\./g' $i
        sed -i 's/P15761_133\_/P15761_133\./g' $i
        sed -i 's/P15761_141\_/P15761_141\./g' $i
        sed -i 's/P15761_149\_/P15761_149\./g' $i
        sed -i 's/P15761_157\_/P15761_157\./g' $i
        sed -i 's/P15761_165\_/P15761_165\./g' $i
        sed -i 's/P15761_173\_/P15761_173\./g' $i
        sed -i 's/P15761_181\_/P15761_181\./g' $i
        sed -i 's/P15761_189\_/P15761_189\./g' $i
        sed -i 's/SRR2500940\_/SRR2500940\./g' $i
        sed -i 's/SRR2681155\_/SRR2681155\./g' $i
        sed -i 's/SRR2681679\_/SRR2681679\./g' $i
        sed -i 's/SRR2682004\_/SRR2682004\./g' $i
        sed -i 's/SRR2682099\_/SRR2682099\./g' $i
        sed -i 's/SRR2682154\_/SRR2682154\./g' $i
        sed -i 's/SRR3105702\_/SRR3105702\./g' $i
        sed -i 's/SRR3105703\_/SRR3105703\./g' $i
        sed -i 's/SRR3105704\_/SRR3105704\./g' $i
        sed -i 's/SRR3105705\_/SRR3105705\./g' $i
        sed -i 's/SRR5760179\_/SRR5760179\./g' $i
        sed -i 's/SRR6374833\_/SRR6374833\./g' $i
        sed -i 's/SRR6375633\_/SRR6375633\./g' $i
        sed -i 's/SRR8454219\_/SRR8454219\./g' $i
        sed -i 's/SRR8506641\_/SRR8506641\./g' $i
        sed -i 's/SRR8524599\_/SRR8524599\./g' $i
        sed -i 's/SRR8617822\_/SRR8617822\./g' $i
        sed -i 's/SRR8641368\_/SRR8641368\./g' $i

        sed -i 's/\_OF\_/\.OF\@/g' $i
	
        mv -- "$i" "${i%_tree.txt}.tre"
    done

Now we should be ready to run PhyloPyPruner, but if there is any error in the files format if will let you know

    # Alignments and gene trees need to be in the same directory
    mkdir 03-PhyloPyPruner_input
    cp 01-OrthoFinder_Alignments/* 03-PhyloPyPruner_input/
    cp 02-Orthofinder_Genetrees/*  03-PhyloPyPruner_input/

    # Run PhyloPyPruner
    phylopypruner --dir 03-PhyloPyPruner_input/ --output 04-PhyloPyPruner_output --no-supermatrix --trim-lb 5 --min-support 60 --mask pdist \
                  --outgroup SRR2500940_Xenoturbella_profunda --prune LS --min-taxa 5

If you are not familiar with PhyloPyPruner you should check its very well-documented Wiki, but this is a short description of the selected parameters:
<ul>
    <li>--no-supermatrix: do not concatenate the output into a supermatrix. We will still clean these alignments, so we are not ready for a supermatrix, yet. Besides, this way PhyloPyPruner will be faster.</li>
    <li>--trim-lb: remove long branches, which are those longer than X times the standard deviation of all branch lengths. Here, we followed the tutorial and chose a factor of five.</li>
    <li>--min-support: collapse nodes with a support value below a given threshold (here, Bootstrap < 60) into polytomies.</li>
    <li>--mask: if two sequences from the same OTU are monophyletic, select only one of them. Here, we kept the sequence with the shortest distance to its sister taxa.</li>
    <li>--outgroup: define the outgroup species to root the trees. If Xenoturbella missing, the method used is midpoint root.</li>
    <li>--prune: there are three methods in PhyloPyPruner to prune out paralogs. In this case, I will use LS (Largest Subtree), which searches the tree, from the root to the tips, for subtrees that contain non-repetetive OTUs. The subtree which contains the highest number of sequences is the "largest subtree" and is retained as an ortholog.</li>
    <li>--min-taxa: discard output alignments with fewer than X OTUs. In orthogroups with only four taxa is very easy to have only three unique sequences, which precludes gene tree inference with bootstrap support. Hence, I will select orthogroups containing at least five species.</li>
</ul>

After pruning all paralogs, the number of orthogroups went down to 6,033. The different stats concerning sequences per alignment have also been affected, but that makes sense because now the maximum number of sequences per alignment is set to 48 (the number of species). The percentage of missing data has gone up from 82.60% to 84.90%. Finally, 2781 branches have been removed after being deemed too long, just 1.38% of the total.

## Prepare the data for phylogenomic analysis
We first did some housekeeping in our set of genes. They were: (1) converted to non-aligned fasta files (removing the gaps), (2) stop codons were removed, (3) the headers were cleaned, to leave only the species name, and (4) we corrected the species names that changed during the course of the study.

    mkdir 05-PhyloPyPruner_output-Clean_genes
    for i in 04-PhyloPyPruner_output/phylopypruner_output/output_alignments/*fa
        do
        sed -E '/>/ s/\.OF\@.+//g' $i > ${i}.rename; mv ${i}.rename $i
        sed -i '/>/! s/\-//g' $i
        sed -i 's/\*//g' $i
	
        sed -i 's/19_228.Sterreria_psammicola/19_228.Sterreria_sp/g' $i
        sed -i 's/20_053.Archaphanostoma_agile/20_053.Baltalimania_agile/g' $i
        sed -i 's/P15761_101.Archaphanostoma_occulta/P15761_101.Baltalimania_occulta/g' $i
        sed -i 's/P15761_102.Isodiametra_sp18/P15761_102.Praeconvoluta_tigrina/g' $i
        sed -i 's/P15761_125.Haplopostia_rubropunctata/P15761_125.Thalassoanaperus_rubellus/g' $i
        sed -i 's/P15761_133.Mecynostomum_sp14/P15761_133.Praeaphanostoma_sp/g' $i
        sed -i 's/P15761_173.Sterreria_sp1/P15761_173.Sterreria_rubra/g' $i
        sed -i 's/P15761_181.Sterreria_sp2/P15761_181.Sterreria_lundini/g' $i
        sed -i 's/SRR6374833.Isodiametra_pulchra/SRR6374833.Aphanostoma_pulchra/g' $i
        sed -i 's/SRR8524599.Pseudaphanostoma_variabilis/SRR8524599.Baltalimania_agile/g' $i
	
        mv -- "$i" "${i%.fa}.fasta"
     done

Thus far, this dataset contains species with more than one specimen. We need to remove the duplicated individuals, leaving only one tip per species. We removed the specimen with the fewest number of orthologs:
    <li>20_038.Philactinoposthia_rhammifera</li>
    <li>20_053.Baltalimania_agile</li>
    <li>P15761_149.Solenofilomorpha_sp2</li>
    <li>P15761_165.Kuma_sp5</li>
    <li>P15761_189.Solenofilomorpha_sp9</li>
    <li>SRR8506641.Symsagittifera_roscoffensis</li>

    mkdir 06-No_duplicates
    cp 05-PhyloPyPruner_output-Clean_genes/ 06-No_duplicates/

    for i in 06-No_duplicates/*fasta
        do
        tr '\n' ' ' < $i | sed 's/\ >/\,>/g' | tr ',' '\n' | egrep -v '20_038|20_053|P15761_149|P15761_165|P15761_189|SRR8506641' | tr ' ' '\n' > ${i}.tmp
        mv ${i}.tmp ${i}
    done

    # Remove alignments with fewer than five sequences
    for i in 06-No_duplicates/*fasta
        do
        sequences=$( grep -c '>' $i )
        if [ $sequences -lt 5 ]; then
            rm $i
        fi
    done

One problem of working with transcriptomes is that sometimes it is difficult to resolve the correct assembly, returning artefactual contigs like chimaeras (i.e. contigs that result from merging two genes into one). This can result in problems during orthology inferences or errors in the alignments. To avoid that, we ran [PREQUAL](https://github.com/simonwhelan/prequal), which pairwise compares the sequences of each fasta file to find regions that do not seem to be homologous to the other sequences. These stretches are removed or masked.

    mkdir 07-Prequal
    cp 06-No_duplicates/*fasta 07-Prequal/

    for i in *fasta
        do
        prequal $i > $i.log
        rm $i
    done

PREQUAL has removed a lot of sequences that were generally bad, as well as masked regions within other sequences that were kept. However, some of these masked regions are larger than we would liked, so we decided to remove all sequences that do not have, at least, 250 unmasked amino acids.

    mkdir 08-Prequal_filter_masked
    cp 07-Prequal/*filtered 08-Prequal_filter_masked

    cd 08-Prequal_filter_masked/

    # Remove masked regions
    for i in *filtered
        do
        sed -i '/>/! s/X//g' $i
    done

To remove sequences shorter than 250 amino acids, we used the "removesmalls.pl" perl script shared in this [Biostars post](https://www.biostars.org/p/79202/).

    for i in *filtered
        do
        perl ./removesmalls.pl 250 $i > $i.fasta
        rm $i
    done

    # Remove fasta files with fewer than five sequences
    for i in *fasta
        do
        seqs=$( grep -c '>' $i)
        if [ $seqs -lt 5 ]; then
            rm $i
        fi
    done

Now, we can compare the original and the edited files to remove all sequences that do not have at least 250 unmasked amino acids:

    # Create a list of the remaining fasta files
    ls *fasta | sed 's/.filtered.fasta//g' > fasta_files.txt

    # Copy the corresponding Prequal files into this directory
    while IFS='' read -r LINE || [ -n "${LINE}" ]
        do
        cp ../07-Prequal//${LINE} ./${LINE}.filtered
    done < ./fasta_files.txt

    # From each file without the short, unmasked sequences, grab the sequence names and find the in the original files. Copy these into a new, clean, masked file
    for i in $( ls *filtered | sed 's/.filtered//g' )
        do
        grep '>' ${i}.filtered.fasta | sort > header_fasta; grep '>' ${i}.filtered | sort > header_filtered
        fgrep -x -f header_fasta  header_filtered > Similarities.txt
        sed -i 's/>//g' Similarities.txt

        while read sequence_id
	    do
            bioawk -v var="${sequence_id}" -c fastx '$name ~ var {print ">"$name"\n"$seq}' $i.filtered >> $i.filtered.rename
        done < ./Similarities.txt
    done

    # Remove the intermediate files and rename the final ones
    rm *fasta *filtered *txt

    for i in *rename
        do
        mv -- "$i" "${i%.fasta.filtered.rename}.fasta.filtered"
    done

With all the files cleaned, it is time to align the sequences. We used [MAFFT](https://github.com/GSLBiotech/mafft) with the L-INS-i algorithm. L-INS-i can align a set of sequences containing sequences flanking around one alignable domain. Although it is more computationally expensive, it produces a more accurate alignment.

    mkdir 09-MAFFT
    cp 08-Prequal_filter_masked/*filtered 09-MAFFT

    for f in 09-MAFFT/*filtered
        do
        mafft-linsi $f > $f.mafft
    done
    rm *filtered

We used [BMGE](https://gitlab.pasteur.fr/GIPhy/BMGE) to clean these alignments. Ambiguously aligned positions were removed with default parameters. Additionally, we removed all sequences with more than 66% gaps and columns with more than 80% gaps (-g 0.66:0.79).

    mkdir 10-BMGE
    cp 09-MAFFT/*mafft 10-BMGE

    for i in 10-BMGE/*mafft
        do
        java -jar BMGE.jar -i $i -t AA -g 0.66:0.79 -of $i.fas > $i.log
    done
    rm *mafft

Since BMGE has removed some sequences from these alignments, we need to check again that all files have at least five species.

    mkdir 11-BMGE_5species
    cp 10-BMGE/*fas 11-BMGE_5species/

    for i in 11-BMGE_5species/*fas
        do
        sequences=$( grep -c '>' $i )
        if [ $sequences -lt 5 ]; then
            rm $i
        fi
    done

Finally, we need to ensure that these genes meet the criteria of homogeneity and stationarity, the so-called symmetry tests. Phylogenetic models rely on various simplifying assumptions to ease computation (homogeneity and stationarity, but also treelikeness and reversibility). If your data severely violates these assumptions, it might cause bias in phylogenetic estimates of tree topologies and other model parameters. We did that with [IQ-TREE 2](https://github.com/iqtree/iqtree2) after concatenating the aligments into a supermatrix with [FASconCAT-G](https://github.com/PatrickKueck/FASconCAT-G).

    # Create the supermatrix
    mkdir 12-FASconCAT-G
    cp 11-BMGE_5species/*fas 12-FASconCAT-G/

    cd 12-FASconCAT-G/
    perl ./FASconCAT-G/FASconCAT-G_v1.05.pl -l -s > FASconCat.log
    rm *mafft.fas
    
    # Run the symmetry tests
    cd ../
    mkdir 13-Symmetry_tests
    cp 12-FASconCAT-G/FcC_supermatrix* 13-Symmetry_tests/

    for i in 13-Symmetry_tests/*fas
        do
        iqtree2 -s FcC_supermatrix.fas -p FcC_supermatrix_partition.txt --symtest-only
    done

Now, manually remove all alignments flagged as non-symmetric.

## *Faerlea glomerata*, a case of cross-contamination?
During the preliminary phylogenetic analyses, just to have a grasp of the data, we noticed the species _Faerlea glomerata_ (at the time classified within Isodiametridae) was recovered nested within the family Proporidae. It was sister to _Haplogonaria minima_. These two species were processed within the same batch, which made us suspect this sample was contaminated. A BLAST search identified 18S from both species in this sample, confirming our suspicion.
To clean this sample, we ran a [Clan test](https://github.com/ChrisCreevey/clan_check). This analysis was described [in this paper](https://academic.oup.com/mbe/article/36/6/1344/5418531?login=true), and it was designed to detect deep paralogy in a phylogeny. The idea is to search for known monophylies in your gene trees and discard those where they are not recovered. Here, we used this approach to flag those genes where _F. glomerata_ was nested within Proporidae.

    mkdir 14-Clan_test
    cp 13-Symmetry_tests/*fas 14-Clan_test/
    cd 14-Clan_test
    
    # Create a "Clans.txt" analysis defining _Faerlea_ as part of Proporidae:
    # 20_026.Haplogonaria_minima 20_063.Faerlea_glomerata 20_073.Kuma_sp5 20_082.Haploposthia_lactomaculata 20_093.Haploposthia_rubropunctata

    # Infer a gene tree for each of the alignments
    for i in *fas
        do
        iqtree -s $i -m MFP -AICc -nt AUTO
    done

    # Concatenate all gene trees into a single file
    cat *treefile Trees_clan_check.phy
    
    # Run the Clan test
    clan_check -f Trees_clan_check.phy -c Clans.txt

Clan_check generates a table where each gene tree is a row and each pre-defined clade a column. For each gene tree and clade, Clan_check will add: "1", if the group is monophyletic, "2" if it is not, and "?" if the target taxa are not present in the tree. With this information, we created a list with all gene trees that returned a "1" (_Faerlea_ + Proporidae do form a clade) called "contaminated_genes.txt" and removed _Faerlea_ from them. Then, the orthogroup was checked to ensure at least five species were present.

    mkdir 15-Full_dataset
    cp 14-Clan_test/*fas 15-Full_dataset/

    # Remove _Faerlea_
    while IFS='' read -r LINE || [ -n "${LINE}" ]
        do
        tr '\n' ' ' < ${LINE}.fas | sed 's/\ >/\,>/g' | tr ',' '\n' | egrep -v 'Faerlea_glomerata' | tr ' ' '\n' > ${LINE}.tmp
        mv ${LINE}.tmp ${LINE}.fas
    done < contaminated_genes.txt

    # Remove the alignments if it has fewer than five species
    for i in *fas
        do
        sequences=$( grep -c '>' $i )
        if [ $sequences -lt 5 ]; then
            rm $i
        fi
    done

Since we have removed one sequence, we decided to realign these files.

    # Change the name of the files for something shorter
    for i in *fas
        do
        mv -- "$i" "${i%.fasta.filtered.mafft.fas}.fasta.filtered"
    done

    # Re-align the fasta files
    for i in *filtered
        do
        mafft-linsi $f > $f.mafft
    done
    rm *filtered

    # Remove unambiguously aligned positions
    for i in *mafft
        do
        java -jar BMGE.jar -i $i -t AA -g 0.66:0.79 -of $i.fas > $i.log
    done
    rm *mafft

This is our **full dataset**.

## Avoiding LBA by removing _Notocelis gullmarensis_ from these alignments
_Notocelis gullmarensis_ is a troublesome worm. This species has proven to be a problematic branch in the tree. Previous phylogenetic attempts (not shown) have recovered Notocelis in different positions of the tree, lowering the support of the nodes where it was positioned. This agrees with the only other study that has included this species, [Jondelius et al, 2011, Systematic Biology](https://academic.oup.com/sysbio/article/60/6/845/1676821).

Here, we decided to infer a backbone tree for Acoelomorpha without this species and then used different topology tests to place it back in the tree. Hence, we need to create a new dataset without this species.

    mkdir 16-Full_dataset_no_Notocelis
    cp 15-Full_dataset/*fas 16-Full_dataset_no_Notocelis/

    # Remove Notocelis
    for i in 16-Full_dataset_no_Notocelis/*fas
        do
        tr '\n' ' ' < $i | sed 's/\ >/\,>/g' | tr ',' '\n' | grep -v 'Notocelis_gullmarensis' | tr ' ' '\n' > ${i}.tmp
        mv ${i}.tmp ${i}
    done

Remove the alignments with fewer than five species

    for i in 16-Full_dataset_no_Notocelis/*fas
        do
        seqs=$( grep -c '>' $i) 
        if [ $seqs -lt 5 ]; then
            rm $i
        fi
    done

Re-align these sequences

    for f in 16-Full_dataset_no_Notocelis/*fas
        do
        mafft-linsi $f > $f.mafft
    done
    rm 16-Full_dataset_no_Notocelis/*fas

    # Remove unambiguously aligned positions
    for i in 16-Full_dataset_no_Notocelis/*mafft
        do
        java -jar BMGE.jar -i $i -t AA -g 0.66:0.79 -of $i.fas > $i.log
    done
    rm 16-Full_dataset_no_Notocelis/*mafft

    # Rename these files
    for i in *fas
        do
        mv -- "$i" "${i%.fas.mafft.fas}.fas"
    done

This is our **full dataset without _Notocelis_**.

## Filtering the data to ameliorate the effect of systematic bias
The full dataset without _Notocelis_ includes 2764 genes, which are too many for some of the analyses. Thus far, the raw data might suffer from different sources of systematic error, such as saturation or compositional heterogeneity. 
To subsample our orthogroups for those more phylogenetically reliable, we used [genesortR](https://github.com/mongiardino/genesortR), which tries to accommodate several sources of systematic bias. From the GitHub page: "[genesortR] estimates seven gene properties commonly used to characterize the information content of loci in phylogenomic datasets: four sources of systematic bias (average pairwise patristic distance, compositional heterogeneity, level of saturation, and root-to-tip variance), two proxies for phylogenetic signal (Robinson-Foulds similarity to a target topology and average bootstrap support), as well as the proportion of variable sites. (...) a principal component analysis (PCA) is used to find an axis of phylogenetic usefulness along which proxies for signal increase while sources of bias decrease."

The result of this analysis can be found on "genesortR-Gene_properties.csv".
Unfortunately, genesortR "was not able to find a "direction", i.e., it doesn't know how to sort the data to maximize the signal and minimize the error." Instead, we filtered the data according to: 
    <li>Occupancy</li>
    <li>Substitution rate</li>
    <li>Saturation</li>
    <li>Compositional heterogeneity</li>
    <li>Average patristic distances (tip-to-tip distance, an indicator of LBA)</li>

We created two datasets for each of these metrics, including the best (1) 300 and (2) 567 genes. The easiest way to do so is to use the genesortR script, which lets you subsample a specific number of genes based on each metric.

    ## In the genesortR script, you need to change:
    ## Set the number of genes in line 59:

    n_genes <- 'all'

    ## Uncomment lines 593 or 594 and change the name of the property you want to subsample:
    
    ###WARNING: uncomment and modify the following lines if you would like to sort
    ###and subsample by a different property, for example occupancy or RF similarity
    variables_sorted <- variables[order(variables[,'occupancy'], decreasing = T),]
    variables_sorted <- variables[order(variables[,'robinson_sim'], decreasing = T),]

Up to this point, we have 11 different matrices. Ten of them (full dataset without _Notocelis_, and the 300 and 567-gene matrices for each of these metrics) were used to infer the backbone phylogeny of Acoelomorpha, while the last one (the full dataset including _Notocelis_) was used to place this species in the tree.
All these matrices are shared in the next section "03-Phylogenomic_analyses", where they will be analysed.

---
